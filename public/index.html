<script>
    const labels = [];
    const waveData = [];

    const ctx = document.getElementById('chart').getContext('2d');

    const gradientWave = ctx.createLinearGradient(0, 0, 0, 320);
    gradientWave.addColorStop(0, 'rgba(112, 217, 112, 0.8)');
    gradientWave.addColorStop(1, 'rgba(112, 217, 112, 0.05)');

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'IR Waveform',
            data: waveData,
            borderColor: '#70d970',
            backgroundColor: gradientWave,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 2,
            cubicInterpolationMode: 'monotone',
          }
        ]
      },
      options: {
        animation: false, // ปิด animation เพื่อให้เร็ว
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            grid: { color: '#224733' },
            ticks: { color: '#a0f0b7' }
          },
          x: { display: false }
        }
      }
    });

    async function fetchData() {
      try {
        const res = await fetch('/data');
        const data = await res.json();

        // อัปเดต BPM
        document.getElementById('hr').textContent = data.bpm > 0 ? data.bpm : '';
        document.getElementById('time').textContent = data.timestamp ? 'Updated: ' + data.timestamp : '';

        // อัปเดต waveform
        labels.push('');
        waveData.push(data.wave);

        if (labels.length > 100) { // เก็บจุดล่าสุด 100 จุด
          labels.shift();
          waveData.shift();
        }

        chart.update();
      } catch (e) {
        console.error('Error fetching data:', e);
      }
    }

    setInterval(fetchData, 50); // อัปเดตทุก 50ms
    fetchData();
</script>
